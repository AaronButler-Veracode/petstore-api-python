
name: 1-Checkout-Artifact-Dockerize-Scan-SynchIssues

on:
  workflow_dispatch:
  schedule:
  - cron: "0 22 * * 1,3,5"

# Checkout, Artifact
jobs:
  Checkout-Artifact:
    runs-on: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v2
            
      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v3.1.0
        with:
        # Artifact name
          name: petstore-api-python.zip
          path: ./

      - name: List folder contents for visual
        run: |
         zip petstore-api-python.zip api.py requirements.txt
         
      - name: List folder contents for visual
        run: |
         ls -la    

# Submit to Veracode for SAST and SCA Scan
      - name: Veracode Upload and Scan Action Step
        uses: veracode/veracode-uploadandscan-action@master
        id: upload_and_scan
        with:
          appname: 'PetstoreAPI-Python-GitHub'
          createprofile: false
          version: '${{ github.run_id }}-'
          criticality: Medium
          filepath: 'petstore-api-python.zip'
          vid: '${{ secrets.VERACODE_API_ID }}'
          vkey: '${{ secrets.VERACODE_API_KEY }}'
        continue-on-error: true  
        
# Dockerize and Publish
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
         username: ${{ secrets.DOCKERHUB_USERNAME }}
         password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v3.2.0
        with:
          context: .
          push: true
          tags: veracodedemolabs/petstore_api_python_github:latest
